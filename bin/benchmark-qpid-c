#!/bin/bash
#
# This shell script automates running the amqp-benchmark [1] against the
# Apache Qpid project [2].
#
# [1]: http://github.com/chirino/amqp-benchmark
# [2]: http://qpid.apache.org
#

true \
${QPID_VERSION:=0.20} \
${QPID_DOWNLOAD:="http://archive.apache.org/dist/qpid/${QPID_VERSION}/qpid-cpp-${QPID_VERSION}.tar.gz"}
#"

BASEDIR=`dirname "$0"`/.. ; cd "${BASEDIR}" ; BASEDIR=`pwd` ; cd - > /dev/null
. ${BASEDIR}/bin/benchmark-setup

function server_start() {
  export QPID_SRC="${WORKSPACE}/qpidc-${QPID_VERSION}"
  export QPID_HOME="${WORKSPACE}/qpidc-${QPID_VERSION}-home"
  export QPID_WORK="${WORKSPACE}/qpidc-${QPID_VERSION}-work"

  # download the sources..
  if [ ! -d "${QPID_SRC}" ]; then
    cd "${WORKSPACE}"
    wget --no-check-certificate "$QPID_DOWNLOAD" -O "qpid-cpp-${QPID_VERSION}.tar.gz"
    tar -zxvf qpid-cpp-${QPID_VERSION}.tar.gz
    rm -rf qpid-cpp-${QPID_VERSION}.tar.gz
  fi

  # build and install..
  if [ ! -d "${QPID_HOME}" ]; then
    cd "${QPID_SRC}"
    
    # Install build dependencies..
    case "`uname`" in
      Linux*) 
        # On a redhat system?
        which yum > /dev/null
        if [ $? -eq 0 ] ; then
          sudo yum groupinstall "Development Tools"
          sudo yum install boost-devel libuuid-devel
        else 
          # Perhaps we are on a ubuntu system..
          which apt-get > /dev/null
          if [ $? -eq 0 ] ; then
            sudo apt-get install build-essential uuid-dev libsasl2-dev sasl2-bin libboost-dev
          fi
        fi
      ;;
    esac
    
    ./configure "--prefix=${QPID_HOME}"
    make install
  fi

  # Cleanup preious executions.
  server_stop
  rm -rf ${QPID_WORK}/*
  mkdir -p "${QPID_WORK}/data"

  CONSOLE_LOG="${REPORTS_HOME}/qpid-c-${QPID_VERSION}.log"
  "${QPID_HOME}/sbin/qpidd" --data-dir "${QPID_WORK}/data" > "${CONSOLE_LOG}" 2>&1 &
  QPID_PID=$!
  echo "Started Qpid with PID: ${QPID_PID}"
  sleep 5
  cat ${CONSOLE_LOG}
}

function benchmark_run() {
  $BENCHMARK_EXEC --display-errors --host $1 --port 5672 --user admin --password password --topic-prefix topic/ --queue-prefix queue/ ${BASEDIR}/scenarios.xml "${REPORTS_HOME}/qpid-${QPID_VERSION}-$(date "+%Y-%m-%d").json"
}

benchmark_main $*


